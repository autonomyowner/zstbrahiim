# PostgreSQL 16 Optimization Configuration for Hetzner CPX31 (8GB RAM)
#
# This file contains recommended PostgreSQL settings optimized for:
# - Server: Hetzner CPX31 (4 vCPU, 8GB RAM, SSD)
# - Use case: Web application with moderate traffic
# - Database size: Up to 50GB
#
# Apply these settings by appending to /etc/postgresql/16/main/postgresql.conf
# Then restart PostgreSQL: systemctl restart postgresql

# ═══════════════════════════════════════════════════════════════
# MEMORY SETTINGS
# ═══════════════════════════════════════════════════════════════

# shared_buffers: 25% of total RAM
shared_buffers = 2GB

# effective_cache_size: 50-75% of total RAM
# This tells PostgreSQL how much memory is available for caching
effective_cache_size = 6GB

# work_mem: Memory for sorting and hash operations
# Formula: (Total RAM - shared_buffers) / (max_connections * 2)
# (8GB - 2GB) / (100 * 2) = 30MB
work_mem = 32MB

# maintenance_work_mem: For VACUUM, CREATE INDEX, etc.
# Recommended: 5-10% of RAM
maintenance_work_mem = 512MB

# ═══════════════════════════════════════════════════════════════
# CONNECTION SETTINGS
# ═══════════════════════════════════════════════════════════════

# Maximum number of connections
max_connections = 100

# ═══════════════════════════════════════════════════════════════
# WRITE-AHEAD LOG (WAL) SETTINGS
# ═══════════════════════════════════════════════════════════════

# WAL buffers: -1 = auto (3% of shared_buffers)
wal_buffers = 16MB

# Checkpoint settings (reduces I/O spikes)
checkpoint_completion_target = 0.9
max_wal_size = 2GB
min_wal_size = 512MB

# ═══════════════════════════════════════════════════════════════
# QUERY PLANNER SETTINGS
# ═══════════════════════════════════════════════════════════════

# random_page_cost: Lower for SSD (default is 4.0 for HDD)
random_page_cost = 1.1

# effective_io_concurrency: Number of concurrent disk I/O operations
# Higher for SSD (200-300), lower for HDD (2-4)
effective_io_concurrency = 200

# ═══════════════════════════════════════════════════════════════
# PARALLELISM SETTINGS
# ═══════════════════════════════════════════════════════════════

# Number of workers for parallel operations
max_worker_processes = 4
max_parallel_workers_per_gather = 2
max_parallel_workers = 4

# ═══════════════════════════════════════════════════════════════
# LOGGING SETTINGS
# ═══════════════════════════════════════════════════════════════

# Log slow queries (queries taking longer than 1 second)
log_min_duration_statement = 1000

# Log connections and disconnections
log_connections = off
log_disconnections = off

# Log line prefix
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '

# Log statement type
log_statement = 'none'  # none, ddl, mod, all

# ═══════════════════════════════════════════════════════════════
# AUTOVACUUM SETTINGS (Maintenance)
# ═══════════════════════════════════════════════════════════════

# Autovacuum on (default)
autovacuum = on

# Reduce autovacuum impact on performance
autovacuum_max_workers = 2
autovacuum_naptime = 60s

# ═══════════════════════════════════════════════════════════════
# STATISTICS
# ═══════════════════════════════════════════════════════════════

# Track query statistics
shared_preload_libraries = 'pg_stat_statements'
pg_stat_statements.track = all
pg_stat_statements.max = 10000

# ═══════════════════════════════════════════════════════════════
# MISCELLANEOUS
# ═══════════════════════════════════════════════════════════════

# Default statistics target (100 is good for most cases)
default_statistics_target = 100

# Timezone
timezone = 'UTC'

# Locale settings
lc_messages = 'en_US.UTF-8'
lc_monetary = 'en_US.UTF-8'
lc_numeric = 'en_US.UTF-8'
lc_time = 'en_US.UTF-8'
